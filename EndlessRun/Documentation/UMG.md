# EndlessRun - UMG クラス説明

このドキュメントでは、UMG のソースコードの主な部分を簡単に説明します。  
※ UMG = Unreal Motion Graphics  
ゲーム中の UI(User Interface)のこと

# TitleMenu クラスの概要

`TitleMenu` クラスは、ゲームのタイトル画面で使用されるユーザーインターフェース（UI）を管理するクラスです。このクラスは、プレイヤーがゲームを開始したり、ゲームを終了したりするためのボタンのクリックイベントを処理します。また、ボタンのクリック時に再生される音や、クリック後に一定の遅延を持たせてゲームの開始や終了を行う処理を提供しています。

## 主な処理内容
- **プロパティのデフォルト値設定**: ボタンやアニメーション、サウンドなどの初期設定を行います。
- **ボタンクリック時のイベント処理**: `Button_Start` および `Button_End` ボタンがクリックされた際に、それぞれゲームの開始や終了の処理をトリガーします。

# このクラスのソースコードの説明

### NativeConstruct 関数

- **概要**: `NativeConstruct` は、`UUserWidget` のライフサイクルの一部であり、ウィジェットが生成された後に呼び出される関数です。
- **Button イベントの設定**: `Button_Start` と `Button_End` のクリックイベントに、それぞれ `OnButtonStartClicked` および `OnButtonEndClicked` 関数をバインドしています。
- **アニメーションの再生**: ロゴのアニメーションを再生し、タイトル画面の視覚的な演出を行います。

### OnButtonStartClicked 関数

- **概要**: `Button_Start` がクリックされた際に呼び出される関数です。
- **音の再生**: `UGameplayStatics::PlaySound2D` を使用してクリック音を再生します。
- **タイマーの設定**: `FTimerHandle` を使い、0.5秒後に `StartGame` 関数を呼び出すタイマーを設定します。これにより、ボタンクリック後の処理に少しの遅延を持たせています。

### OnButtonEndClicked 関数

- **概要**: `Button_End` がクリックされた際に呼び出される関数です。
- **音の再生**: `OnButtonStartClicked` 同様に、クリック音を再生します。
- **タイマーの設定**: 0.5秒後に `EndGame` 関数を呼び出すタイマーを設定し、クリック後に少しの遅延を持たせてゲームを終了します。

### StartGame 関数

- **概要**: ゲームを開始するための処理を行う関数です。
- **イベントのブロードキャスト**: `OnGameStarted` イベントをブロードキャストし、ゲームの開始を他のオブジェクトに通知します。

### EndGame 関数

- **概要**: ゲームを終了するための処理を行う関数です。
- **ゲーム終了の実行**: `UKismetSystemLibrary::QuitGame` 関数を使用してゲームを終了させます。引数を通じて終了時の挙動を設定しています。

# CountDown クラスの概要

`CountDown` クラスは、ゲーム開始前にカウントダウンを表示するためのUIウィジェットを管理するクラスです。このクラスは、プレイヤーキャラクターの入力を一時的に無効にし、カウントダウンの進行に合わせてテキストの表示を切り替えます。カウントダウンが完了すると、プレイヤーの入力を再度有効にし、ゲームが開始されます。

## 主な処理内容
- **プロパティのデフォルト値設定**: カウントダウンに使用するテキストブロックやプレイヤーキャラクターの初期状態を設定します。
- **カウントダウン時のテキストの不透明度変更**: カウントダウンの進行に応じて、対応するテキストブロックの不透明度を切り替えます。

# このクラスのソースコードの説明

### NativeConstruct 関数

- **概要**: `NativeConstruct` は、ウィジェットが生成された後に呼び出される関数です。この関数では、プレイヤーキャラクターの入力を無効にし、カウントダウンに使用するテキストブロックの初期化を行います。
- **プレイヤーの入力無効化**: カウントダウンが完了するまで、プレイヤーが操作できないようにします。
- **テキストブロックの初期化**: カウントダウンの各段階で表示されるテキストブロックを `CountTexts` 配列に追加します。
- **カウントダウンタイマーの設定**: `UpdateCountdown` 関数を1秒ごとに呼び出すタイマーを設定し、カウントダウンを進行させます。

### SetTextBlockOpacity 関数

- **概要**: テキストブロックの不透明度を変更するためのユーティリティ関数です。
- **不透明度の設定**: 指定されたテキストブロックの色に対して不透明度（アルファ値）を変更し、視覚的な表示/非表示を切り替えます。

### UpdateCountdown 関数

- **概要**: カウントダウンの進行を管理する関数です。テキストブロックの不透明度を変更し、カウントダウンが完了したらプレイヤーの入力を再度有効にして、ゲームを開始します。
- **不透明度の変更**: `CountDownTime` に応じて、対応するテキストブロックの不透明度を変更し、現在のカウントダウン段階を視覚的に示します。
- **カウントダウンの完了処理**: `CountDownTime` が0以下になると、タイマーをクリアし、プレイヤーの入力を有効にしてゲームを開始します。また、ゲームモードの `Tick` を再開し、ゲームプレイが正常に進行するようにします。最後にカウントダウンウィジェットを画面から削除します。

# RunScore クラスの概要

`RunScore` クラスは、ゲームプレイ中のUIにおいて、プレイヤーが獲得したコイン数や走行距離を表示するためのクラスです。このクラスは、ゲームモードから取得したデータを `TextBlock` にバインドして、リアルタイムでプレイヤーに情報を提供します。

## 主な処理内容
- **プロパティのデフォルト値設定**: `TextBlock` ウィジェットに表示する値の初期設定を行います。
- **`TextBlock` に値をバインド**: プレイヤーのコイン数や走行距離をゲームモードから取得し、UIのテキストとしてリアルタイムに表示します。

# このクラスのソースコードの説明

### Initialize 関数

- **概要**: `Initialize` 関数はウィジェットが初期化される際に呼び出される関数で、`TextBlock` に表示するテキストのデリゲートを設定します。
- **バインドの設定**: `TextBlock_CoinsCount` と `TextBlock_MileageMeter` の `TextDelegate` に、それぞれコイン数と走行距離を設定する関数 (`SetTextBlockCoinsCount` と `SetTextBlockMileageMeter`) をバインドしています。これにより、テキストの表示内容が動的に更新されます。

### SetTextBlockCoinsCount 関数

- **概要**: この関数は、プレイヤーが獲得したコイン数をテキストとして取得し、`TextBlock_CoinsCount` に表示します。
- **ゲームモードからコイン数を取得**: `ARunGameMode` クラスからコインの総数を取得し、`UKismetTextLibrary::Conv_IntToText` 関数を使用して、`FText` に変換します。この変換されたテキストが `TextBlock_CoinsCount` に表示されます。

### SetTextBlockMileageMeter 関数

- **概要**: この関数は、プレイヤーが走行した距離をテキストとして取得し、`TextBlock_MileageMeter` に表示します。
- **走行距離の取得と変換**: `ARunGameMode` クラスから総走行距離を取得し、`UKismetMathLibrary::FTrunc` 関数を使って整数部分に切り捨て、`UKismetTextLibrary::Conv_IntToText` 関数でテキストに変換します。このテキストが `TextBlock_MileageMeter` に表示されます。